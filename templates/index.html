<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Style Weaver</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Welcome to Style Weaver</h1>
            <p>Chat with your AI style assistant or choose from trending styles!</p>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Chatbot Section -->
            <section class="chatbot-section">
                <div class="chatbot-container">
                    <div class="chatbot-header">
                        <h2>💬 What's on your mind?</h2>
                        <p>Tell me about your style preferences or choose from our trending options below!</p>
                    </div>
                    
                    <!-- Chat Messages Area -->
                    <div class="chat-messages" id="chatMessages">
                        <div class="message bot-message">
                            <div class="message-content">
                                <span class="bot-avatar">🎨</span>
                                <div class="message-text">
                                    Hi! I'm your Style Weaver assistant. What kind of look are you going for today? You can describe your mood, occasion, or pick from our trending styles!
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Describe your style mood or ask me anything..." maxlength="500">
                        <button id="sendChatBtn" class="send-btn">
                            <span class="send-icon">📤</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Style Options Section -->
            <section class="style-options-section">
                <div class="section-header">
                    <h3>Or choose from trending styles:</h3>
                </div>
                <div class="style-buttons-container">
                    <button class="style-option-btn" data-trend="90s Revival">
                        <span class="style-emoji">🎸</span>
                        <div class="style-info">
                            <h4>90s Revival</h4>
                            <p>Grunge, casual, streetwear vibes</p>
                        </div>
                    </button>
                    <button class="style-option-btn" data-trend="Minimalist Chic">
                        <span class="style-emoji">✨</span>
                        <div class="style-info">
                            <h4>Minimalist Chic</h4>
                            <p>Clean, simple, professional vibes</p>
                        </div>
                    </button>
                    <button class="style-option-btn hacker-mode-btn" data-trend="Hacker Mode">
                        <span class="style-emoji">🎯</span>
                        <div class="style-info">
                            <h4>Hacker Mode</h4>
                            <p>Tech-inspired, innovative looks</p>
                        </div>
                    </button>
                </div>
                <p class="hacker-mode-description">✨ <strong>Hacker Mode:</strong> AI combines the hacker tee with the model to create a perfect tech-inspired look!</p>
            </section>

            <!-- Loading Section -->
            <section class="loading-section" id="loadingIndicator" style="display: none;">
                <div class="loading-spinner"></div>
                <p class="loading-text">Generating your perfect style...</p>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="resultsSection" style="display: none;">
                <div class="generated-image-container">
                    <img id="generated-image" alt="Generated Style Board" class="generated-image">
                </div>
                
                <div class="outfit-details">
                    <h2>You will need:</h2>
                    <div id="outfit-items-container" class="outfit-items-container">
                        <!-- Individual clothing item images will be added here -->
                    </div>
                </div>
                
                <button class="try-another-btn" onclick="resetApp()">Try Another Trend</button>
            </section>

            <!-- Error Section -->
            <section class="error-section" id="errorSection" style="display: none;">
                <div class="error-message">
                    <h3>Oops! Something went wrong</h3>
                    <p id="errorText"></p>
                    <button class="try-again-btn" onclick="resetApp()">Try Again</button>
                </div>
            </section>
        </main>
    </div>

    <!-- JavaScript -->
    <script>
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to all style option buttons
            const styleButtons = document.querySelectorAll('.style-option-btn');
            styleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const trendName = this.getAttribute('data-trend');
                    // Add to chat as user selection
                    addMessageToChat(`I want to try the ${trendName} style!`, 'user');
                    // Add bot response
                    addMessageToChat(`Great choice! Let me generate a ${trendName} look for you. ✨`, 'bot');
                    generateStyle(trendName);
                });
            });
            
            // Add chat functionality
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendChatBtn');
            
            // Send message on button click
            sendBtn.addEventListener('click', sendChatMessage);
            
            // Send message on Enter key
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        });
        
        // Chat functionality
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            
            // Clear input
            chatInput.value = '';
            
            // Process message and respond
            processChatMessage(message);
        }
        
        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (sender === 'bot') {
                messageContent.innerHTML = `
                    <span class="bot-avatar">🎨</span>
                    <div class="message-text">${message}</div>
                `;
            } else {
                messageContent.innerHTML = `
                    <div class="message-text">${message}</div>
                    <span class="user-avatar">👤</span>
                `;
            }
            
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        async function processChatMessage(message) {
            try {
                // Show typing indicator
                addMessageToChat('Thinking...', 'bot');
                
                // Call chat API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                const chatMessages = document.getElementById('chatMessages');
                const lastMessage = chatMessages.lastElementChild;
                if (lastMessage && lastMessage.querySelector('.message-text').textContent === 'Thinking...') {
                    chatMessages.removeChild(lastMessage);
                }
                
                if (data.success) {
                    // Add bot response
                    addMessageToChat(data.response, 'bot');
                    
                    // If a style suggestion was made, offer to generate it
                    if (data.suggested_style) {
                        setTimeout(() => {
                            addMessageToChat(`Would you like me to generate a ${data.suggested_style} look for you?`, 'bot');
                            // Add quick action buttons
                            addQuickActionButtons(data.suggested_style);
                        }, 1000);
                    }
                } else {
                    addMessageToChat('Sorry, I had trouble understanding that. Could you try rephrasing?', 'bot');
                }
            } catch (error) {
                // Remove typing indicator
                const chatMessages = document.getElementById('chatMessages');
                const lastMessage = chatMessages.lastElementChild;
                if (lastMessage && lastMessage.querySelector('.message-text').textContent === 'Thinking...') {
                    chatMessages.removeChild(lastMessage);
                }
                
                addMessageToChat('Sorry, I\'m having connection issues. Please try again!', 'bot');
            }
        }
        
        function addQuickActionButtons(styleName) {
            const chatMessages = document.getElementById('chatMessages');
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'message bot-message quick-actions';
            
            buttonDiv.innerHTML = `
                <div class="message-content">
                    <div class="quick-action-buttons">
                        <button class="quick-action-btn yes-btn" onclick="generateStyleFromChat('${styleName}')">
                            ✨ Yes, generate it!
                        </button>
                        <button class="quick-action-btn no-btn" onclick="removeQuickActions()">
                            Maybe later
                        </button>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(buttonDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function generateStyleFromChat(styleName) {
            removeQuickActions();
            addMessageToChat(`Perfect! Generating your ${styleName} look now...`, 'bot');
            generateStyle(styleName);
        }
        
        function removeQuickActions() {
            const quickActions = document.querySelectorAll('.quick-actions');
            quickActions.forEach(action => action.remove());
        }
        
        // Main function to generate style
        async function generateStyle(trendName) {
            console.log('🎨 Generating style for trend:', trendName);
            
            // Show loading indicator
            showLoadingIndicator();
            
            try {
                // Make API call to generate style
                const response = await fetch('/api/generate-style', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ trend_name: trendName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    showError(data.message || data.error || 'Failed to generate style');
                }
            } catch (error) {
                console.error('Error generating style:', error);
                showError('Failed to connect to the server. Please try again.');
            } finally {
                hideLoadingIndicator();
            }
        }
        
        // Display the results
        function displayResults(data) {
            console.log('📊 Displaying results:', data);
            
            // Update the generated image
            const generatedImage = document.getElementById('generated-image');
            if (data.generated_image_url) {
                // Handle both base64 data URLs and regular URLs
                if (data.generated_image_url.startsWith('data:image/')) {
                    // Base64 image from Gemini processing
                    generatedImage.src = data.generated_image_url;
                } else {
                    // Regular URL
                    generatedImage.src = data.generated_image_url;
                }
                generatedImage.style.display = 'block';
                
                // Add error handling for image loading
                generatedImage.onerror = function() {
                    console.error('Failed to load generated image');
                    this.style.display = 'none';
                    // Show a fallback message
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.className = 'image-fallback';
                    fallbackDiv.innerHTML = '<p>✨ Outfit generated successfully! Image processing complete.</p>';
                    fallbackDiv.style.cssText = 'text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 10px 0;';
                    this.parentNode.insertBefore(fallbackDiv, this.nextSibling);
                };
                
                generatedImage.onload = function() {
                    console.log('✅ Generated image loaded successfully');
                };
            } else {
                // Show placeholder if no image
                generatedImage.style.display = 'none';
            }
            
            // Clear and populate outfit items container
            const outfitItemsContainer = document.getElementById('outfit-items-container');
            outfitItemsContainer.innerHTML = '';
            
            if (data.outfit_items && data.outfit_items.length > 0) {
                data.outfit_items.forEach(item => {
                    // Create outfit item element
                    const itemElement = document.createElement('div');
                    itemElement.className = 'outfit-item';
                    
                    // Create item image
                    const itemImage = document.createElement('img');
                    itemImage.src = item.image_url || 'https://via.placeholder.com/150x200/f8f9fa/333333?text=' + encodeURIComponent(item.type || 'Item');
                    itemImage.alt = item.description || 'Fashion item';
                    itemImage.className = 'outfit-item-image';
                    
                    // Create item description
                    const itemDescription = document.createElement('p');
                    itemDescription.className = 'outfit-item-description';
                    itemDescription.textContent = item.description || 'Fashion item';
                    
                    // Add elements to item container
                    itemElement.appendChild(itemImage);
                    itemElement.appendChild(itemDescription);
                    
                    // Add item to container
                    outfitItemsContainer.appendChild(itemElement);
                });
            } else {
                // Show message if no items found
                const noItemsMessage = document.createElement('p');
                noItemsMessage.className = 'no-items-message';
                noItemsMessage.textContent = 'No matching items found in your wardrobe for this trend.';
                outfitItemsContainer.appendChild(noItemsMessage);
            }
            
            // Show results section
            showSection('resultsSection');
        }
        
        // Show loading indicator
        function showLoadingIndicator() {
            document.getElementById('loadingIndicator').style.display = 'block';
            hideSection('resultsSection');
            hideSection('errorSection');
        }
        
        // Hide loading indicator
        function hideLoadingIndicator() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            showSection('errorSection');
        }
        
        // Show specific section
        function showSection(sectionId) {
            document.getElementById(sectionId).style.display = 'block';
        }
        
        // Hide specific section
        function hideSection(sectionId) {
            document.getElementById(sectionId).style.display = 'none';
        }
        
        // Reset app to initial state
        function resetApp() {
            hideSection('resultsSection');
            hideSection('errorSection');
            hideLoadingIndicator();
            
            // Clear results
            document.getElementById('generated-image').src = '';
            document.getElementById('outfit-items-container').innerHTML = '';
            
            // Remove any fallback messages
            const fallbackDivs = document.querySelectorAll('.image-fallback');
            fallbackDivs.forEach(div => div.remove());
        }
        
        // Health check on load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                console.log('✅ Health check:', data.status);
            } catch (error) {
                console.warn('⚠️ Health check failed:', error);
            }
        });
    </script>
</body>
</html>
